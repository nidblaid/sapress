<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="kzm_report_invoice_document"
              inherit_id="account.report_invoice_document">

        <xpath expr="//t[@t-set='address']" position="replace">

            <t t-set="address">
                <span t-if="o.partner_id.ref">Code client:
                    <span t-field="o.partner_id.ref"></span>
                </span>
                <address t-field="o.partner_id"
                         t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/>
                <span t-if="o.partner_id.vat"><t
                    t-esc="o.company_id.country_id.vat_label or 'Tax ID'"/>:
                    <span t-field="o.partner_id.vat"/>
                </span>
                <t t-if="o.partner_id.ice">
                    <t t-if="o.partner_id.vat">
                        <br/>
                    </t>
                    ICE:
                    <span t-field="o.partner_id.ice"/>
                </t>
                <t t-if="not o.partner_id.ice">
                    <t t-if="o.partner_id.parent_id and o.partner_id.parent_id.ice">
                        <t t-if="o.partner_id.vat">
                            <br/>
                        </t>
                        ICE:
                        <span t-field="o.partner_id.parent_id.ice"/>
                    </t>
                </t>

            </t>

        </xpath>

        <!--        <xpath expr="//div[hasclass('page')]//table[@name='invoice_line_table']"-->
        <!--               position="before">-->
        <!--            <p t-if="o.company_id.kzm_object_invoicing">-->
        <!--                <strong>-->
        <!--                    <span t-esc="o.get_order_object()"></span>-->
        <!--                </strong>-->
        <!--            </p>-->
        <!--        </xpath>-->


        <xpath expr="//div[hasclass('page')]//table[@name='invoice_line_table']/thead/tr"
               position="replace">
            <t t-set="colspan" t-value="6"/>
            <t t-if="o.company_id.kzm_numbering_invoicing">
                <th>
                    <strong>Náµ’</strong>
                </th>
            </t>
            <t t-if="o.company_id.kzm_code_designation_invoicing">
                <th>
                    <strong>Reference</strong>
                </th>
                <th>
                    <strong>Designation</strong>
                </th>
            </t>
            <t t-if="not o.company_id.kzm_code_designation_invoicing">
                <th class="text-left">
                    <span>Description</span>
                </th>
            </t>

            <!--<th class="d-none text-left">
                <span>Source Document</span>
            </th>-->
            <th class="text-right">
                <span>Quantity</span>
            </th>
            <th t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                <span>Unit Price</span>
            </th>
            <th t-if="display_discount"
                t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                <span>Disc.(%)</span>
                <t t-set="colspan" t-value="colspan+1"/>
            </th>
            <t t-if="not o.company_id.kzm_taxe_invoicing">
                <th t-attf-class="text-left {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                    <span>Taxes</span>
                    <t t-set="colspan" t-value="colspan+1"/>
                </th>
            </t>

            <th class="text-right">
                <span groups="account.group_show_line_subtotals_tax_excluded">Amount
                </span>
                <span groups="account.group_show_line_subtotals_tax_included">Total
                    Price
                </span>
            </th>
        </xpath>
        <xpath expr="//tbody[hasclass('invoice_tbody')]" position="replace">
            <t t-set="current_subtotal" t-value="0"/>

            <t t-foreach="o.invoice_line_ids" t-as="line">

                <t t-set="current_subtotal"
                   t-value="current_subtotal + line.price_subtotal"
                   groups="account.group_show_line_subtotals_tax_excluded"/>
                <t t-set="current_subtotal"
                   t-value="current_subtotal + line.price_total"
                   groups="account.group_show_line_subtotals_tax_included"/>

                <tr t-att-class="'bg-200 font-weight-bold' if line.display_type == 'line_section' else 'font-italic' if line.display_type == 'line_note' else ''">
                    <t t-if="not line.display_type"
                       name="account_invoice_line_accountable">
                        <t t-if="o.company_id.kzm_numbering_invoicing">
                            <td style="width:3px;">
                                <span class="text-nowrap" t-esc="str(line_index+1)"/>
                            </td>
                        </t>
                        <t t-if="o.company_id.kzm_code_designation_invoicing">
                            <td>
                                <span t-field="line.product_id.default_code"></span>
                            </td>
                            <td>
                                <t t-set="desc" t-value="line.product_id.name"/>
                                <!--                                <p t-raw="desc"></p>-->
                                <p t-raw="line.get_designation()"></p>
                            </td>
                        </t>
                        <t t-if="not o.company_id.kzm_code_designation_invoicing">
                            <td name="account_invoice_line_name">
                                <span t-field="line.name"/>
                            </td>
                        </t>

                        <!--<td class="d-none">
                            <span t-field="line.origin"/>
                        </td>-->
                        <td class="text-right">
                            <span t-field="line.quantity"/>
                            <span t-field="line.product_uom_id" groups="uom.group_uom"/>
                        </td>
                        <td t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                            <span t-field="line.price_unit"
                                  t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                        </td>
                        <td t-if="display_discount"
                            t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                            <span t-field="line.discount"/>
                        </td>
                        <t t-if="not o.company_id.kzm_taxe_invoicing">
                            <td t-attf-class="text-left {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                <span t-esc="', '.join(map(lambda x: (x.description or x.name), line.tax_ids))"/>

                            </td>
                        </t>

                        <td class="text-right">
                            <span t-field="line.price_subtotal"
                                  groups="account.group_show_line_subtotals_tax_excluded"/>
                            <span t-field="line.price_total"
                                  groups="account.group_show_line_subtotals_tax_included"/>
                        </td>
                    </t>
                    <t t-if="line.display_type == 'line_section'">
                        <td t-att-colspan="colspan">
                            <span t-field="line.name"/>
                        </td>
                        <t t-set="current_section" t-value="line"/>
                        <t t-set="current_subtotal" t-value="0"/>
                    </t>
                    <t t-if="line.display_type == 'line_note'">
                        <td t-att-colspan="colspan">
                            <span t-field="line.name"/>
                        </td>
                    </t>
                </tr>

                <t t-if="current_section and (line_last or o.invoice_line_ids[line_index+1].display_type == 'line_section')">
                    <tr class="is-subtotal text-right">
                        <td t-att-colspan="colspan">
                            <strong class="mr16">Subtotal</strong>
                            <span
                                t-esc="current_subtotal"
                                t-options='{"widget": "monetary", "display_currency": o.currency_id}'
                            />
                        </td>
                    </tr>
                </t>
            </t>
        </xpath>
        <xpath expr="//div[hasclass('clearfix')]//tr[1]" position="after">
            <tr class="border-black" style="border-bottom:1px solid #dddddd;"
                t-if="display_discount and o.company_id.kzm_discount_invoicing">
                <td>
                    <strong>Total Discount</strong>
                </td>
                <td class="text-right">
                    <span t-esc="o.get_discount()"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                </td>
            </tr>
        </xpath>
        <xpath expr="//div[hasclass('clearfix')]//tr[1]" position="replace">
            <tr t-if="not o.company_id.kzm_discount_invoicing" class="border-black"
                style="border-bottom:1px solid #dddddd;">
                <td>
                    <strong>Total HT</strong>
                </td>
                <td class="text-right">
                    <span t-esc="o.amount_untaxed"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                </td>
            </tr>
            <tr t-if="o.company_id.kzm_discount_invoicing" class="border-black"
                style="border-bottom:1px solid #dddddd;">
                <td>
                    <strong>Total HT Brut</strong>
                </td>
                <td class="text-right">
                    <span t-esc="o.total_ht()"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                </td>
            </tr>
        </xpath>
        <xpath expr="//t[@t-foreach='o.amount_by_group']" position="replace">
            <t t-foreach="o.amount_by_group" t-as="amount_by_group">
                <tr style="border-bottom:1px solid #dddddd;">
                    <t t-if="len(o.line_ids.filtered(lambda line: line.tax_line_id)) == 1 and o.amount_untaxed == amount_by_group[2]">
                        <td>
                            <span t-esc="amount_by_group[0]"/>
                        </td>
                        <td class="text-right">
                            <span t-esc="amount_by_group[3]"/>
                        </td>
                    </t>
                    <t t-else="">
                        <td>
                            <span t-esc="amount_by_group[0]"/>
                        </td>
                        <td class="text-right">
                            <span t-esc="amount_by_group[3]"/>
                        </td>
                    </t>
                </tr>
            </t>
        </xpath>
        <xpath expr="//div[hasclass('clearfix')]//div[@id='total']" position="after">

            <t class="" t-if="o.company_id.kzm_amount_letter_invoicing">
                <p>
                    Approved this invoice for the sum of :
                    <strong>
                        <span t-esc="o.currency_id.amount_to_text(o.amount_total)"/>
                    </strong>
                </p>
            </t>


        </xpath>
        <xpath expr="//p[@name='payment_term']" position="after">

            <t t-if="o.invoice_partner_bank_id and o.company_id.kzm_bank_invoicing">
                <span>
                    <strong>Banking coordinates</strong>
                </span>
                <br/>


                <span>
                    <span style="width:25%">Bank :</span>
                    <span t-field="o.invoice_partner_bank_id.bank_id.name"/>
                    <t t-if="o.invoice_partner_bank_id.bank_id.street">
                        <br/>
                        <span
                            t-field="o.invoice_partner_bank_id.bank_id.street"/>,

                    </t>

                    <t t-if="o.invoice_partner_bank_id.bank_id.street2">
                        <span
                            t-field="o.invoice_partner_bank_id.bank_id.street2"/>
                        -
                    </t>

                    <t t-if="o.invoice_partner_bank_id.bank_id.city">
                        <span
                            t-field="o.invoice_partner_bank_id.bank_id.city"/>
                        -
                    </t>
                    <span t-if="o.invoice_partner_bank_id.bank_id.country"
                          t-field="o.invoice_partner_bank_id.bank_id.country"/>
                </span>

                <span t-if="o.invoice_partner_bank_id.acc_number" style="width:25%">
                    <br/>Account number :
                </span>
                <span t-field="o.invoice_partner_bank_id.acc_number"/>

                <span t-if="o.invoice_partner_bank_id.iban" style="width:25%"><br/>Code
                    IBAN :
                </span>
                <span t-field="o.invoice_partner_bank_id.iban"/>

                <span t-if="o.invoice_partner_bank_id.bank_id.bic" style="width:25%">
                    <br/>Code BIC/SWIFT :
                </span>
                <span t-field="o.invoice_partner_bank_id.bank_id.bic"/>
                <br/>
            </t>

        </xpath>


    </template>

</odoo>
